---
title: "Predicting Short-Term Rental Prices in Amsterdam Using Airbnb Data"
author: "Maddy Kornhauser & Ejiro Ojeni"
date: "12/11/2020"
output: 
  html_document: 
        code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(width = 60)
local({
  hook_output <- knitr::knit_hooks$get('output')
  knitr::knit_hooks$set(output = function(x, options) {
    if (!is.null(options$max.height)) options$attr.output <- c(
      options$attr.output,
      sprintf('style="max-height: %s;"', options$max.height)
    )
    hook_output(x, options)
  })
})

library(tidyverse)
library(sf)
library(sp)
library(ggcorrplot)
library(viridis)
library(caret)
library(stargazer)
library(kableExtra)
library(FNN)
library(osmdata)
library(spdep)
library(grid)
library(gridExtra)
library(raster)

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

nn_function <- function(measureFrom,measureTo,k) {
  measureFrom_Matrix <- as.matrix(measureFrom)
  measureTo_Matrix <- as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    dplyr::summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint) %>%
    pull()
  
  return(output)  
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

pal <- viridisLite::viridis(5)

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

q5 <- function(variable) {as.factor(ntile(variable, 5))}
```

## 1. Introduction

With its unique attractions, beautiful architecture, and scenic views, it’s no wonder why Amsterdam remains a top tourist attraction for travellers around the globe. In the modern era, where flights are less expensive, tourism has surged in the city, along with the demand for short-term rentals. Rising home prices, few issued building permits and low density all factor into a lack of affordable housing in Amsterdam. However, people are increasingly blaming an relative newcomer to Amsterdam - Airbnb. Although Airbnb only arrived in the city in 2014, it has already made its mark currently accounting for 12% of the City’s overnight bookings. 

To help Amsterdam’s public housing officials proactively prevent a rapid conversion of long-term rental units to short-term rentals for tourists, The Concerned Citizens of Amsterdam’s data analytics team has developed Fairbnb. Fairbnb is a website that identifies which units are at risk of conversion by calculating the potential revenue difference between what owners are currently making leasing long-term units and what they could be making if their unit converted to a short-term rental listed on Airbnb. The units that have the greatest revenue difference are identified as the properties that have the highest risk of being converted. If replicated, this analysis could help policy officials in other cities properly manage Airbnb's by knowing where to proactively build affordable housing or where and how to target Airbnb regulatiosn, such as limiting permits in certain high-risk areas, and rental time restrictions. With this additional infomration and predictive power, Amsterdam can strike an optimal balance between protecting housing units and encouraging tourism, which is an important economic sector in the city.

## 2. Data Wrangling & Exploratory Analysis

The primary datasets that we used to conduct this analysis were a 2018 dataset of Airbnb listings [^1] in Amsterdam an a 2020 datset of long-term apartment listings from the Dutch rental site, Pararius [^2]. Since the long-term apartment listings were not readily available we scraped the listing data from their search page using instructions found on a Toward Data Science blog post [^3] and the worked with a University of Pennsylvania librarian to geocode the addresses using the ESRI World Geocoder. 

```{r data pull 1, echo=TRUE, message=FALSE, warning=FALSE}
nhoods <- st_read("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=GEBIED_BUURTCOMBINATIES_EXWATER&THEMA=gebiedsindeling", quiet = TRUE)
#calculating and converting from sq meters to sqmiles
nhoods$area <- area(as(nhoods, "Spatial")) *3.861e-7 

nhoods.sf <- nhoods %>%
  st_as_sf() %>%
  st_transform('EPSG:28992')

airbnb <- read.csv('./data/listings_details.csv') 
airbnb.sf <- airbnb %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform('EPSG:28992') %>%
  dplyr::select("price", "bedrooms", "geometry") %>%
  mutate(Type = "Short-Term") %>%
  na.omit()
airbnb.sf$price <- as.numeric(gsub('[$,]', '', airbnb.sf$price)) #removing $ signs from price

apartments <- st_read('./data/AmsterdamAptsGeocode.json', quiet = TRUE) %>%
  st_transform('EPSG:28992')
apartments.sf <- apartments %>%
  dplyr::select('house_pric', 'bedrooms', 'geometry') %>%
  st_as_sf() %>%
  st_centroid() %>%
  mutate(price = (house_pric*1.21)/30) %>% #conver to USD + get nightly price by dividing by 30
  dplyr::select('price', 'bedrooms', 'geometry') %>%
  mutate(Type = 'Long-Term') %>%
  st_as_sf() %>%
  na.omit()
apartments.sf <- subset(apartments.sf, price >0)
apartments.sf <- subset(apartments.sf, bedrooms <4)

```

Figures X.X and X.X provide an overview of 2018 Airbnb counts by neighborhood. Both maps represent the count of Airbnbs by neighborhood with the map on the right normalized by nieghborhood area. Both representations show that there is a concentration of units in the center of Amsterdam in popular tourist neighborhoods such as Jordaan and De Pijp within the city's canal ring. The popularity of these neighborhoods is unsurprising as they areas are centrally located near main attractions.

```{r}
airbnb_count_normalized <- airbnb.sf %>%
  mutate(count = 1) %>%
  dplyr::select(count) %>%
  aggregate(., nhoods.sf, sum) %>%
  st_join(., nhoods.sf) %>%
  mutate(norm = count / area) %>%
  ggplot() +
  geom_sf(aes(fill=norm)) + 
  scale_fill_viridis() +
  labs(title = "Airbnb's per Square Mile by Neighborhood") +
  mapTheme()

airbnb_count <- airbnb.sf %>%
  mutate(count = 1) %>%
  dplyr::select(count) %>%
  aggregate(., nhoods.sf, sum) %>%
  ggplot() +
  geom_sf(aes(fill=count)) + 
  scale_fill_viridis() +
  labs(title = "Airbnb's by Neighborhood") +
  mapTheme()

grid.arrange(airbnb_count, airbnb_count_normalized, 
             ncol = 2, 
             top = textGrob("2018 Airbnb's by Neighborhood", 
                            gp=gpar(fontsize=20)))

```

Despite the large supply of Airbnb's in central Amsterdam, this does not translate into lower price. While price trends do not exactly follow the spatial patterns we see in the above Figures X.X, we observe that more expensive properties tend to be located near the city center. This suggests that even with the concentration, there is still high demand for Airbnb units in the central district and hosts are able to charge higher rates.

```{r message=FALSE, warning=FALSE}
airbnb.sf %>%
  dplyr::select(price) %>%
  filter(price < 250) %>%
  aggregate(., nhoods.sf, median) %>%
  ggplot() +
  geom_sf(aes(fill=price)) + 
  scale_fill_viridis() +
    labs(title = "Average Nightly Airbnb Price by Neighborhood",
       subtitle = "Figure X.X") +
  mapTheme()

```

**Do we want to include the district map?**

```{r}
districts <- st_read("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=GEBIED_BUURTCOMBINATIES_EXWATER&THEMA=gebiedsindeling")

districts <- districts %>%
  group_by(Stadsdeel_code) %>%
  summarise() 

districts.sf <- districts %>%
  st_as_sf() %>%
  st_transform('EPSG:28992')


ggplot() + geom_sf(data = districts.sf, aes(fill = Stadsdeel_code))

airbnb.sf %>%
  mutate(count = 1) %>%
  dplyr::select(count) %>%
  aggregate(., districts.sf, sum) %>%
  ggplot() +
  geom_sf(aes(fill=count)) + 
  scale_fill_viridis() +
  labs(title = "Airbnbs by District",
       subtitle = "Figure X.X") +
  mapTheme()
```

Turning to the long-term apartment dataset, Figures X.X  and X.X maps the location and price of the apartments for which we will ultimately predict short-term revenue.  The map on the left shows trends in absolute price while the map on the right breaks down price by quitile. Unlike the price trends for the short-term Airbnb rentals, the apartment prices appear to be far more normalized with the apartments in the highest quintile dispersed throughout the city instead of being concentrated in central Amsterdam.

```{r message=FALSE, warning=FALSE}
apts_price <- ggplot() +
  geom_sf(data = nhoods, fill = "grey60") +
  geom_sf(data = apartments.sf, aes(colour = price), size = .7) +
  scale_color_viridis() +
  labs(title = "Long-Term Rentals to Predict Short-Term Revenue") + 
  mapTheme()

apts_qprice <- ggplot() +
  geom_sf(data = nhoods, fill = "grey60") +
  geom_sf(data = apartments.sf, aes(colour = q5(price)), size = .7) +
  scale_color_manual(values = pal) +
  labs(title = "Long-Term Rentals to Predict Short-Term Revenue") + 
  mapTheme()

grid.arrange(apts_price, apts_qprice, 
             ncol = 2, 
             top = textGrob("Amsterdam Apartments", 
                            gp=gpar(fontsize=20)))
```

Finally comparing the bedroom size between our two datasets, we see that Airbnb's have a higher share of one-bedroom units than the long-term apartment dataset.  This would have us believe that smaller units are more likely to be converted than larger units.

```{r}
aribnb_beds <- airbnb.sf %>%
  filter(bedrooms < 4 & bedrooms > 0) %>%
  ggplot(., aes(bedrooms)) +
  geom_bar() +
  labs(title = "Short-Term",
       subtitle = "Figure X.X") +
  plotTheme()

apt_beds <- apartments.sf %>%
  filter(bedrooms < 4) %>%
  ggplot(., aes(bedrooms)) +
  geom_bar() + 
  labs(title = "Long-Term",
       subtitle = "Figure X.X") + 
  plotTheme()


grid.arrange(aribnb_beds, apt_beds, 
             ncol = 2, 
             top = textGrob("Long-Term vs. Short-Term Units: Number of Bedrooms", 
                            gp=gpar(fontsize=20)))
```
nt and high nightly 
Since our ultimate goal was to predict the short-term revenue for long-term rental apartments, we needed to combine the apartment and the Airbnb observations into a single dataset that would serve as the basis for our analysis.  While the Airbnb data is an incredibly rich dataset that provides detailed information on the housing type (care to rent a lighthouse, anyone?), household amenities, and past guestratings, this was not available for the long-term housing data. The only overlapping data was the price, the number of bedrooms, and location. Therefore, our foundational dataset, compiled in the following code was quite basic.

```{r message=FALSE, warning=FALSE}
df <- rbind(airbnb.sf, apartments.sf)
head(df)
```

Given the limitations discussed  above, we decided to simplify our datatset and remove outlier units with a high bedroom coucost. We removed all units over 3 bedrooms and any unit that cost over $1000 per night.  Our final dataset included over 20 thousand observations, 19400 short-term rentals from Airbnb and 1,360 long-term rental from Pararius.

```{r message=FALSE, warning=FALSE}
#Remving outliers
df <- subset(df, bedrooms < 4)
df <- subset(df, price > 0)
df <- subset(df, price < 1000)
```

### Outside Amenities

We suplemented this base data with information pulled from Amsterdam's comprehensive Open Data Portal and features from OpenStreetMap. The following variables were ultimately incorporated into our final model.

- Neighborhood Boundaries
- Bike Stands
- Bike Rentals
- Historic Amsterdam-Binnen de Singelgracht district
- Brothels
- Restaurants

```{r data pull 2, message=FALSE, warning=FALSE}
#---Open Data Amsterdam
bikestands <- st_read("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=FIETSTAXI_STANDPLAATSEN&THEMA=fietstaxi", quiet = TRUE) %>%
  st_transform('EPSG:28992')
bikestands.sf <- st_join(bikestands, nhoods.sf, join = st_intersects, left = FALSE)

conservation <- st_read("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=BESCHERMDESTADSGEZICHTEN&THEMA=cultuurhistorie", quiet = TRUE) %>%
  st_transform('EPSG:28992') 
Ams_Binnen <- conservation %>%
  filter(Naam_gebied =="Amsterdam-Binnen de Singelgracht") 
Ams_Binnen.sf <- st_join(Ams_Binnen, nhoods.sf, join = st_intersects, left = FALSE)

#---Open Street Map
#Boundary for OSM to reference
amsBoundary <- st_read("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=GEBIEDEN25&THEMA=gebiedsindeling", quiet = TRUE)

#Setting the bounding box
xmin = st_bbox(amsBoundary)[[1]]
ymin = st_bbox(amsBoundary)[[2]]
xmax = st_bbox(amsBoundary)[[3]]  
ymax = st_bbox(amsBoundary)[[4]]

#Querying the API
bikerental <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'amenity', value = c("bicycle_rental")) %>%
  osmdata_sf()
#Extracting point data
bikerental <- bikerental$osm_points %>% .[amsBoundary,]
#Projecting & converting to sf object
bikerental.sf <- bikerental %>%
  dplyr::select(geometry) %>%
  na.omit() %>%
  st_transform('EPSG:28992') %>%
  distinct() %>%
  st_centroid()

brothels <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'amenity', value = c("brothel")) %>%
  osmdata_sf()
brothels <- brothels$osm_points %>% .[amsBoundary,]
brothels.sf <- brothels %>%
  dplyr::select(geometry) %>%
  na.omit() %>%
  st_transform('EPSG:28992') %>%
  distinct() %>%
  st_centroid()

restaurants <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'amenity', value = c("restaurant", "cafe")) %>%
  osmdata_sf()
restaurants <- restaurants$osm_points %>% .[amsBoundary,]
restaurants.sf <- restaurants %>%
  dplyr::select(geometry) %>%
  na.omit() %>%
  st_transform('EPSG:28992') %>%
  distinct() %>%
  st_centroid()
```

We incorporated the outside data to our base dataset by generating nearest neighbor variables to understand the amenity's proximity to each location. 
```{r add data to df, message=FALSE, warning=FALSE}
#Nearest neighbor variable
df <- 
  df %>%
  mutate(bikerental_nn = nn_function(st_coordinates
                               (st_centroid(df)),
                               st_coordinates(st_centroid(bikerental.sf)), 3),
         bikestands_nn = nn_function(st_coordinates
                                      (st_centroid(df)), 
                                      st_coordinates(st_centroid(bikestands.sf)), 3),
         brothels_nn = nn_function(st_coordinates
                                   (st_centroid(df)), 
                                   st_coordinates(st_centroid(brothels.sf)), 5),
         restaurants_nn = nn_function(st_coordinates
                                       (st_centroid(df)), 
                                       st_coordinates(st_centroid(restaurants.sf)), 3),
        AmsBinnen_nn = nn_function(st_coordinates
                                   (st_centroid(df)), 
                                   st_coordinates(st_centroid(Ams_Binnen.sf)), 1))

head(df)
```

### Spatial Process

To capture the spatial process of price clustering, we engineered a spatial lag variable to incorporate the price of the 10 closest units.
```{r message=FALSE, warning=FALSE}
coords <- st_coordinates(df) 
neighborList10 <- knn2nb(knearneigh(coords, 10))
spatialWeights10 <- nb2listw(neighborList10, style="W")
df$lagPrice10 <- lag.listw(spatialWeights10, df$price)

head(df)
```

Another important spatial variable incorporated into our model was the categorical neighborhood variable. Since the neighborhood boundaries in Amsterdam are fairly small, this ultimately became a very significant variable in our model and may have outweighed other amenity information that we tried to include.  

```{r}
#Joining neighborhood data
df <- st_join(df, nhoods.sf) %>%
  rename(neighborhood = Buurtcombinatie) %>%
  dplyr::select(-Opp_m2, ) %>%
  na.omit() %>%
  st_as_sf()
```

### Housing Characteristics

As we mentioned before, most Airbnb datapoints were unfortunately not available to use in this analysis, even though many were potentially signficant in predicting the price. Though  not a perfect solution we reversed engineered certain numeric Airbnb variables based on the number of bedrooms in an apartment.  For example, we determined the average number of guests, bathrooms, and beds for units in each bedroom group and created a variable to represent those average numbers. While we attempted to engineer a handful of Airbnb variables which are shown in Table X below, the number of guests a unit accomodated was ultimately the only signficant variable incorporated into our model.

```{r message=FALSE, warning=FALSE}
airbnb %>% 
  filter(bedrooms >0 & bedrooms <4) %>%
  dplyr::select(bedrooms, accommodates, beds, bathrooms) %>%
  group_by(bedrooms) %>%
  summarise(mean_accommodates = mean(accommodates),
            mean_beds = mean(beds, na.rm = TRUE),
            mean_baths = mean(bathrooms, na.rm = TRUE)) %>%
  kable(caption = "Table X.X") %>%
  kable_styling()

df <-
  df %>% 
  mutate(accommodates = ifelse(bedrooms == 1, 2.24,ifelse(bedrooms == 2, 3.76, 4.45))) 
```

### Log Transformations

Finally, much of our data was not normally distributed. We used the log transformations of the variables, which ultimately worked better in the model. And example of the log transformation is shown in Figure X.X below, where the transformed variable on the left has a stronger correlation with the price of the unit than the untransformed variable on the left.

```{r message=FALSE, warning=FALSE}
df$logprice <- log(df$price)
df$logrestaurants <- log(df$restaurants_nn)
df$logbikestand <- log(df$bikestands_nn)
df$logbikerentals <- log(df$bikerental_nn)
df$logAmsBinnen <- log(df$AmsBinnen_nn)
df$logbrothels <- log(df$brothels_nn)

correlation.long <-
  st_drop_geometry(df) %>%
  filter(bedrooms < 6) %>%
  dplyr::select(price,
                # restaurants_nn,
                # logrestaurants,
                # bikerental_nn,
                logbikerentals
                ) %>%
  gather(Variable, Value, -price) 
  
pal

correlation.cor <-
  correlation.long %>%
  group_by(Variable) %>%
  summarize(correlation = cor(Value, price, use = "complete.obs"))

ggplot(correlation.long, aes(Value, price)) +
  geom_point(size = 0.1) +
  geom_text(data = correlation.cor, aes(label = paste("r =", round(correlation, 2))),
            x=-Inf, y=Inf, vjust = 1.5, hjust = -.1) +
  geom_smooth(method = "lm", se = FALSE, colour = "red") +
  facet_wrap(~Variable, ncol = 1, scales = "free") +
  #labs(title = "Log Transformation Examples") +
  plotTheme()
```

### Exploratory Analysis 

Our final selection of variables, represented in the below corrplot, show that the housing characteristics and spatial variables have a positive relationship with housing price while the amenity variables, based on nearest neighbor distances, have a negative correlation with price. This makes sense as the farther a unit is located from the amenity, the lower the price.

```{r message=FALSE, warning=FALSE}
numericVars <-
  select_if(df, is.numeric) %>%
  st_drop_geometry() %>%
  dplyr::select(price,
                bedrooms,
                accommodates,
                lagPrice10,
                logrestaurants,
                bikestands_nn,
                logbikerentals,
                logbrothels,
                brothels_nn,
                logAmsBinnen
                ) %>%
  na.omit()

ggcorrplot(
  round(cor(numericVars), 1),
  p.mat = cor_pmat(numericVars),
  colors = c("#440154FF", "white", "#FDE725FF"),
  type="lower",
  insig = "blank") +
  labs(title = "Correlation across numeric variables",
       subtitle = "Figure X.X")

```

#Mention neighborhoods

## 3. Methods

### OLS Regression

Filtering out the long-term rentals and splitting our data into separate training and testing datasets, we ran an OLS regression to predict the nightly rental price of each unit. The results of the regression are summarized in the table below. 

```{r attr.output='style="max-height: 300px;"'}
df_reg <- subset(df, Type == "Short-Term")

#Setting up test and training datasets
inTrain <- createDataPartition( 
  y = paste(df_reg$neighborhood), 
  p = .70, list = FALSE)

df.training <- df_reg[inTrain,] 
df.test <- df_reg[-inTrain,]  

#Multivariate regression
reg.vars <- c("price",
              "neighborhood",
              "bedrooms",
              "accommodates",
              "lagPrice10",
              "logrestaurants",
              "bikestands_nn",
              "logbikerentals",
              "logbrothels",
              "brothels_nn",
              "logAmsBinnen"
              )

reg1 <- lm(price ~ ., data = st_drop_geometry(df.training) %>% 
             dplyr::select(all_of(reg.vars)))

stargazer(
  reg1,
  type = "text",
  title = "Linear Model Summary Table",
  dep.var.caption = " ",
  dep.var.labels = "Model Features")
```

The model has a relatively low Adjusted R Square, likely due to the limited housing characteristic information we could include. When we review the model's error terms by applying the algorithm to the test set, we calculate a Mean Average Error (MAE) of about \$44 and the Mean Average Percent Error (MAPE) of 30%.  The error terms are summarized in the below table. While the model still struggles with accuracy, this  is an improvement on our beta model presented in class, which had a MAE of about $240 and a 70% MAPE. We attribute these improvements primarily to removing outliers in the dataset and log transforming our variables.

```{r}
df.test <-
  df.test %>%
  mutate(Regression = "Baseline Regression",
         SalePrice.Predict = predict(reg1, df.test),
         SalePrice.Error = SalePrice.Predict - price,
         SalePrice.AbsError = abs(SalePrice.Predict - price),
         SalePrice.APE = (abs(SalePrice.Predict - price)) / SalePrice.Predict)

ErrorTable <- 
  df.test %>% 
  dplyr::summarize(Regression = "Baseline Regression",
                   MAE = mean(SalePrice.AbsError, na.rm = T), 
                   MAPE = mean(SalePrice.AbsError, na.rm = T) / mean(price, na.rm = T)) 

ErrorTable %>%
  st_drop_geometry() %>%
  kable(caption = "MAE and MAPE for Test Set Data") %>%
  kable_styling()

```

### Cross Validation

While there are undoubtedly issues with the model's accuracy the model seems to be fairly generalizable with the majority of errors clustered between \$40 and \$50 dollars and the average MAE and R squared being very similar to the outputs from our original model. Figure X.X show the distribution of errors across the 100 folds.  

DO WE WANT TO INCLUDE STANDARD DEVIATION?

```{r}
fitControl <- trainControl(method = "cv", 
                           number = 100,
                           savePredictions = TRUE)

set.seed(717)
reg1.cv <- 
  train(price ~ ., data = st_drop_geometry(df_reg) %>% 
          dplyr::select(all_of(reg.vars)), 
        method = "lm", 
        trControl = fitControl, 
        na.action = na.pass)

reg1.cv

#Standard Deviation and Histogram of MAE
reg1.cv.resample <- reg1.cv$resample

sd(reg1.cv.resample$MAE)

ggplot(reg1.cv.resample, aes(x=MAE)) + geom_histogram(color = "grey40", fill = "#232761ff", bins = 50) + 
  labs(title="Histogram of Mean Average Error Across 100 Folds",
       subtitle = "Figure X.X") +
  plotTheme()
```

### 4. Results & Findings

With the final model tested and trained we next predicted the short-term revenue potential for the long-term apartment dataset. The following lines of code apply the predictive model to the apartment data to predict a nightly price, transform the value into monthly revenue and calculate the absolute and percent difference. The output of this analysis are shown in the maps in below.

```{r}
df$predict <- predict(reg1, newdata = df)
df$monthlyprice <- df$price*30
df$monthlypred <- df$predict*30
df$absdiff <- abs(df$monthlyprice - df$monthlypred)
df$pctdiff <- df$absdiff / df$monthlyprice

longterm <- df %>% filter(Type == "Long-Term")

Pct_diff <- ggplot() +
  geom_sf(data = nhoods) +
  geom_sf(data = longterm, aes(colour = q5(pctdiff)), size = .9) +
  scale_color_manual(values = pal) +
  labs(title = "Percent Difference") + 
  mapTheme()

Abs_diff <- ggplot() +
  geom_sf(data = nhoods, fill = "grey60") +
  geom_sf(data = longterm, aes(colour = q5(absdiff)), size = .9) +
  scale_color_manual(values = pal) +
  labs(title = "Absolute Diference") + 
  mapTheme()

grid.arrange(Pct_diff, Abs_diff, 
             ncol = 2, 
             top = textGrob("Difference Between Long-Term & Short-Term Rental Revenue", 
                            gp=gpar(fontsize=20)))
```

Though our model has issues with accuracy, these findings make sense. They show that apartments closest to the central core of Amsterdam, a particularly desirable area for tourists, have the largest difference in revenue between short-term and long-term rentals. Therefore, these central units are the most at risk for converting to short-term rentals.

Besides proximity to the central core, bedrooms also seem to play a role in generating a high-risk unit. The below Figure X.X shows that larger 2-bedroom and 3-bedroom units have a larger share of units in the top quintile of percent difference in revenue. Despite there being more 2- and 3- bedroom units available per our exploratory analysis, this finding suggests that owners have a greater incentive to convert these larger units to short-term rentals. They may therefore be at higher risk. This could have serious implications for families and larger households in Amsterdam seeking affordable housing, as owners of these larger units appear to have a greater upside in converting their units to short-term rentals.

```{r}
ggplot(df, aes(fill=q5(pctdiff), y=price, x=bedrooms)) + 
  geom_bar(position="fill", stat="identity") + 
  scale_fill_viridis(discrete = T)  + 
  labs(title = "Percent Price Difference Quintile by Bedrooms in Unit",
       subtitle = "Figure X.X") +
  plotTheme()

```

## 5. Conclusions
Through this analysis, we reveal that in Amsterdam, larger units closest to the city center show the greatest risk of conversion, with owners seeing on average a potential revenue increase of nearly 50% in revenue when converting their units to short-term rentals. This result is understandable because the city center typically hosts a plethora of tourist attractions and larger units can accommodate groups of travellers and command a higher price. 
	
This underlying algorithm for Fairbnb's website allows Amsterdam policymakers to identify units with large revenue gaps and helps proactively safeguard affordable housing for residents where Airbnb would have otherwise begun to dominate.  The accuracy of the model could be improved if more detailed information about long-term rentals' internal characteristics were available. In the Airbnb data, variables such as the number of beds, the number of guests the unit could accommodate, or the property type, were shown to have a strong correlation to rental price. However, with these key internal characteristics missing from the Pararius apartment data, the model’s accuracy in predicting equivalent Airbnb units was adversely affected. 

Another wrinkle in the internal characteristic data is that many of this information simply is not available for long-term apartments and would be determined by the involvement of the host.  Guest reviews, for example, would not exist for long-term units that have no yet converted and would largely depend on the potential host's investment in the property. If they are highly motivated to create a top Airbnb destination, then they may be able to charge more for additional amenities and services.

In Amsterdam, these internal characteristics are particularly key to improving the model because Amsterdam’s amenities and public services are evenly distributed throughout the city. Being a well-served city,these amenity features were not as helpful in predicting a unit’s price as we initially hoped. In addition, the next iteration of the model could incorporate specific, popular landmarks and other tourist sites to help better capture the higher prices units next to these features could have. An additional consideration is including demogrpahic data into the analysis, which we are currently lacking.

If these improvements are made, there is no doubt that local policymakers would be able to properly manage Airbnb usage and allow tourists to continue enjoying the city, but not at the expense of its native residents.

[^1]: Kaggle
[^2]: Pararius
[^3]: Toward Data Science